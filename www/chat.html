<!-- <!doctype html>
<html>
<head>
    <title>bksysnet@hcmut welcome</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
<div>
    <form action="/submit-data" method="post">
        <button type="submit">Start chatting</button>
    </form>
</body>
</html> -->

<!DOCTYPE html>

<html><body>

<style>
    .message-window {
        width: 100%;
        max-height: 20rem;
        overflow: scroll;
    }
</style>

<div>
    <h3 id="greet"></h3>
</div>

<div>
    <h3>Online peers</h3>
    <div id="peerslist" class="peerlist">

    </div>
</div>

<div>
    <h3>Channels</h3>
    <div id="channels"">

    </div>
</div>

<div>
    <h3>Direct Messages</h3>
    <div id="direct messages">

    </div>
</div>

<div>
    <h3>Send Direct message</h3>
    <div>
        <form id="sendToPeer" method="POST" action="/send">
            <input name="peer address" type="text">
            <input name="message" type="text">
            <button type="button" onclick="sendToPeer()">Send Data</button>
        </form>
    </div>
</div>

<div>
    <h3>Broadcast message</h3>
    <div>
        <form id="broadcast" method="POST" action="/send">
            <input name="message" type="text">
            <button type="button" onclick="broadcast()">Send Data</button>
        </form>
    </div>
</div>

<script>
    let CLIENT = "0.0.0.0:9000";
    let PEERLIST = [];
    const TRACKER = 'http://0.0.0.0:9998';

    function displayMessage(username, msg, channel = "") {
        let paragraph = document.createElement('p');
        paragraph.textContent = username + ": " + msg;

        if (!channel) {
            let displaylist = document.getElementById('direct messages');
            displaylist.appendChild(paragraph);
            return;
        }
    }

    async function sendRequest(url, method = 'GET', data = null) {
        try {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                str = JSON.stringify(data);
                options.body = str;
            }

            const response = await fetch(url, options);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`); 
            }

            const result = await response.json();
            return result;
        } catch (error) {
            console.error('API Error:', error);
            return null;
        }
    }

    async function pollPeers() {
        PEERLIST = await sendRequest('/list', "GET");
        let peerlist = document.getElementById('peerslist');
        peerlist.innerHTML = "";
        PEERLIST.forEach(p => {
            let content = p['username'] + ' (' + p['id'] + ')';
            let connected = p['connected'];

            if (p['id'] == CLIENT) {
                content += ' (You)';
            }

            if (connected) {
                content += ' (Connected)';
            }

            let container = document.createElement('div');
            
            let peernode = document.createElement('p');
            peernode.textContent = content;

            container.appendChild(peernode);
         
            if (!connected && p['id'] != CLIENT) {
                let button = document.createElement('button')
                button.textContent = "Connect"
                button.type = "Button";
                button.addEventListener("click", () => {
                    console.log("Connecting to", p['id'], '...')
                    sendRequest('/connectpeer', 'POST', p['id'])
                    pollPeers()
                });
                container.appendChild(button);
            }

            peerlist.appendChild(container);

        });
    }

    async function sendToPeer() {
        let form = document.getElementById('sendToPeer')
        let data = new FormData(form);
        let addr = data.get('peer address')
        let msg = data.get('message')

        if (msg.length == 0) {
            console.log("Message must not be empty.");
            return;
        }

        await sendRequest('/send', 'POST', {
            'receiver': addr,
            'message': msg
        }).then((v) => {
            displayMessage("[You]", msg);
        }).catch((x) => 
            console.log("Failed to send message to peer")
        )
    }

    async function broadcast() {
        let form = document.getElementById('broadcast')
        let data = new FormData(form);
        let msg = data.get('message')

        if (msg.length == 0) {
            console.log("Message must not be empty.");
            return;
        }

        await sendRequest('/broadcast', 'POST', msg)
        .then((v) => {
            displayMessage("[You]", msg);
        }).catch((x) => 
            console.log("Failed to send message to peer")
        )
    }

    async function startPolling(func, time, startnow = true) {
        if (startnow) {
            func();
        }
    
        setInterval(() => func(), time);
    }

    async function pollMessages() {
        await sendRequest('/pollinbox', 'GET')
            .then((list) => {
                list.forEach((msg) => {
                    let peername = 'Guest';
                    console.log(msg);

                    PEERLIST.forEach((v) => {
                        if (v['id'] == msg['sender']) peername = v['username']
                    });

                    displayMessage(peername, msg['message'])
                });
            });
    }

    async function pollChannels() {
        await sendRequest('/listchannels', 'GET').then((v) => {
            console.log(v);

            channellist = document.getElementById('channels')
            channellist.textContent = "";

            v.forEach((c) => {
                let ch = document.createElement('p');
                ch.textContent = c['name'] + " (Members:";
                let joined = false;

                c['peers'].forEach((p) => {
                    if (p == CLIENT) {
                        joined = true;
                        ch.textContent += ' [You]';
                    } else {
                        let peername = 'Guest';
            
                        PEERLIST.forEach((v) => {
                            if (v['id'] == p) peername = v['username'];
                        });

                        ch.textContent += ' ' + peername;
                    }
                })

                ch.textContent += ')';

                channellist.appendChild(ch);

                if (!joined) {
                    let button = document.createElement('button')
                    button.textContent = "Join"
                    button.type = "Button";
                    button.addEventListener("click", () => {
                        sendRequest('/joinchannel', 'POST', c['name'])
                    });
                    channellist.appendChild(button);
                }
            });
        })
    }

    async function main() {
        // Receive own username
        await sendRequest('/get', 'GET')
            .then((v) => {
                let selfname = v['username']
                CLIENT = v['ip'] + ':' + v['port'];
                document.getElementById('greet').textContent = "Hello " + selfname;
            });

        console.log(CLIENT)

        startPolling(pollPeers, 5000, true);
        startPolling(pollMessages, 1000);
        startPolling(pollChannels, 10000, true);
    }

    main()
</script>

</body></html>